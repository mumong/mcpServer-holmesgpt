# 本地部署与调试

与 Docker/K8s 部署使用**同一套源码**（`start.py` + 各 server），仅通过**配置文件**区分环境，保证行为一致。

---

## 1. 环境要求

- **Python 3.10+**，建议使用项目内 `.venv`
- **Node.js + npm**（用于 `mcp-proxy`，本地 server 通过 `npx mcp-proxy` 暴露 SSE）
- 按需：**kubectl**（启用 k8s-core 时）、**helm**（启用 helm-tools 时）

---

## 2. 一键本地启动（推荐）

```bash
# 在项目根目录执行
make run-local
```

会自动：

- 若存在 `mcp_config.local.yaml` 则优先使用，否则使用 `mcp_config.yaml`
- 若存在 `.venv` 则激活
- 若未安装 Python 依赖则执行 `pip install -r requirements.txt`
- 启动 `python start.py --config <选中的配置>`

启动后终端会打印各 MCP 的 SSE 地址（如 `http://localhost:8091/sse` 等），用 AIOps/客户端连这些地址即可。

---

## 3. 使用本地专用配置（不改动仓库配置）

若不想改仓库里的 `mcp_config.yaml`，可单独维护一份本地配置：

```bash
cp mcp_config.local.example.yaml mcp_config.local.yaml
# 编辑 mcp_config.local.yaml：关闭不需要的服务、改 PROMETHEUS_URL 等
make run-local
```

`mcp_config.local.yaml` 已加入 `.gitignore`，不会提交。

---

## 4. 仅启动、不自动选配置

```bash
# 使用默认 mcp_config.yaml
make run
# 或
python start.py

# 指定配置文件
python start.py --config mcp_config.local.yaml
```

---

## 5. 与 Docker 部署的对应关系

| 项目       | Docker 部署                    | 本地部署                          |
|------------|--------------------------------|-----------------------------------|
| 入口       | `CMD ["python", "start.py", "--config", "/app/config/mcp_config.yaml"]` | `python start.py --config mcp_config.yaml`（或 `mcp_config.local.yaml`） |
| 配置来源   | ConfigMap 挂载到 `/app/config/mcp_config.yaml` | 当前目录下的 `mcp_config.yaml` 或 `mcp_config.local.yaml` |
| 端口       | 与 config 中 `port` 一致，由 Deployment/Service 暴露 | 本机相同端口（8091–8097 等），直接访问 localhost |
| 依赖       | 镜像内已装 Python/Node/kubectl 等 | 本机需安装 Python、Node，按需 kubectl/helm |

逻辑完全一致，仅配置路径与运行环境不同。

---

## 6. 常见问题

- **端口被占用**：在所用配置里改对应服务的 `port`，或关掉占用该端口的程序。
- **k8s-core 报错**：本地需已安装并配置好 `kubectl`（能访问目标集群）。
- **prometheus 连不上**：在配置里为该服务设置 `env.PROMETHEUS_URL` 为本地或可访问的 Prometheus 地址。
